%% Copilot Secure Deployment Phases
%% Three-phase rollout with gates and checkpoints

graph TD
    subgraph "Phase 1: Pre-Rollout Hardening"
        P1A[Audit permission exposure<br/><i>SharePoint, OneDrive, Teams, Email</i>]
        P1B[Identify sensitivity label conflicts<br/><i>Confidential + broad sharing</i>]
        P1C[Remediate overshared content<br/><i>Revoke anonymous links, restrict scope</i>]
        P1D[Fix SharePoint inheritance breaks<br/><i>Audit broken permission inheritance</i>]
        P1E[Run 6 posture checks<br/><i>All HIGH must pass</i>]
        P1F[Configure Conditional Access<br/><i>Block high-risk users</i>]
        P1G[Set up dynamic security groups<br/><i>Departing, compromised, external</i>]

        P1A --> P1B --> P1C --> P1D
        P1D --> P1E --> P1F --> P1G
    end

    P1G --> GATE1{Gate 1<br/>All HIGH posture<br/>checks pass?}
    GATE1 -->|No| FIX1[Fix failing checks<br/>Return to Phase 1]
    FIX1 --> P1E
    GATE1 -->|Yes| PHASE2

    subgraph "Phase 2: Pilot Deployment"
        PHASE2[Enable Copilot for pilot group]
        P2A[Deploy detection policies<br/><i>Preview mode only</i>]
        P2B[Monitor Copilot interactions<br/><i>Build usage baseline</i>]
        P2C[Tune alert thresholds<br/><i>Reduce false positives</i>]
        P2D[Review connected app scopes<br/><i>Initial scope baseline</i>]
        P2E[Address MEDIUM posture checks<br/><i>Device compliance, audit logging</i>]

        PHASE2 --> P2A --> P2B --> P2C --> P2D --> P2E
    end

    P2E --> GATE2{Gate 2<br/>Baseline established<br/>+ MEDIUM checks pass?}
    GATE2 -->|No| FIX2[Continue monitoring<br/>Fix MEDIUM checks]
    FIX2 --> P2C
    GATE2 -->|Yes| PHASE3

    subgraph "Phase 3: Production Rollout"
        PHASE3[Broad Copilot enablement]
        P3A[Switch detection to Production mode<br/><i>Full SOC/SIEM routing</i>]
        P3B[Enable SOAR automation<br/><i>Auto-response workflows</i>]
        P3C[Continuous scope drift monitoring<br/><i>Plugin permission tracking</i>]
        P3D[Ongoing governance cadence<br/><i>Daily/Weekly/Monthly/Quarterly</i>]

        PHASE3 --> P3A --> P3B --> P3C --> P3D
    end

    P3D --> LOOP[Continuous Improvement Loop]
    LOOP --> P3C

    style GATE1 fill:#2d3436,color:#fff
    style GATE2 fill:#2d3436,color:#fff
    style FIX1 fill:#d63031,color:#fff
    style FIX2 fill:#e17055,color:#fff
    style PHASE2 fill:#0984e3,color:#fff
    style PHASE3 fill:#00b894,color:#fff
    style LOOP fill:#6c5ce7,color:#fff
